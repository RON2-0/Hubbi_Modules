name: Release Plugin ğŸ“¦

on:
  push:
    tags:
      - '*@*' # Se activa con tags tipo "nombre@version"

permissions:
  contents: write # Permiso para crear Releases

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Parse Tag
        id: tag_info # ID necesario para leer los outputs despuÃ©s
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Tag original: $TAG_NAME"
          
          # Separamos nombre y versiÃ³n
          PLUGIN_NAME=${TAG_NAME%@*}
          VERSION=${TAG_NAME##*@}
          
          # 1. Guardamos en ENV para usarlo en scripts de terminal (bash)
          echo "PLUGIN_NAME=$PLUGIN_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # 2. Guardamos en OUTPUT para usarlo en parÃ¡metros de acciones (yaml)
          echo "plugin_name=$PLUGIN_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "ğŸ¯ Target: $PLUGIN_NAME | v$VERSION"

      - name: ğŸ” Verify Plugin Exists
        run: |
          if [ ! -d "$PLUGIN_NAME" ]; then
            echo "âŒ Error: No existe la carpeta '$PLUGIN_NAME' en el repositorio."
            exit 1
          fi

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install Dependencies
        run: |
          cd $PLUGIN_NAME
          npm ci

      - name: ğŸ› ï¸ Build Plugin
        run: |
          cd $PLUGIN_NAME
          npm run build

      - name: ğŸ“„ Prepare Manifest
        run: |
          cd $PLUGIN_NAME
          # Actualizamos la versiÃ³n en el manifest temporalmente
          tmp=$(mktemp)
          jq --arg v "$VERSION" '.meta.version = $v' dist/manifest.json > "$tmp" && mv "$tmp" dist/manifest.json
          echo "âœ… Manifest version bumped to $VERSION"

      - name: ğŸ¤ Zip Package
        run: |
          cd $PLUGIN_NAME/dist
          # Creamos el archivo .hubbi en la raÃ­z del repo
          zip -r ../../$PLUGIN_NAME.hubbi .
          echo "ğŸ“¦ Empaquetado listo: $PLUGIN_NAME.hubbi"

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          # AQUI EL CAMBIO: Usamos 'steps.tag_info.outputs' en lugar de 'env'
          files: ${{ steps.tag_info.outputs.plugin_name }}.hubbi
          name: "${{ steps.tag_info.outputs.plugin_name }} v${{ steps.tag_info.outputs.version }}"
          body: |
            ğŸš€ **Nuevo Release del MÃ³dulo**
            - Plugin: `${{ steps.tag_info.outputs.plugin_name }}`
            - VersiÃ³n: `${{ steps.tag_info.outputs.version }}`
            
            Descarga el archivo `.hubbi` e impÃ³rtalo en tu aplicaciÃ³n.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}