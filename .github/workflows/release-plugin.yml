name: Release Plugin üì¶

on:
  push:
    tags:
      - '*@*' # Se activa cuando empujas un tag con formato "nombre@version"

permissions:
  contents: write # Necesario para crear el Release y subir archivos

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üè∑Ô∏è Parse Tag
        id: tag_info
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Tag original: $TAG_NAME"
          
          # Separamos por el √∫ltimo '@'
          PLUGIN_NAME=${TAG_NAME%@*}
          VERSION=${TAG_NAME##*@}
          
          echo "PLUGIN_NAME=$PLUGIN_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          echo "üéØ Detectado Plugin: $PLUGIN_NAME | Versi√≥n: $VERSION"

      - name: üîç Verify Plugin Exists
        run: |
          if [ ! -d "$PLUGIN_NAME" ]; then
            echo "‚ùå Error: No existe la carpeta '$PLUGIN_NAME' en el repositorio."
            exit 1
          fi

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üì¶ Install Dependencies
        run: |
          cd $PLUGIN_NAME
          npm ci # Instalaci√≥n limpia

      - name: üõ†Ô∏è Build Plugin
        run: |
          cd $PLUGIN_NAME
          npm run build
          # Vite genera el index.umd.cjs en /dist

      - name: üìÑ Prepare Manifest
        # Aseguramos que el manifest tenga la versi√≥n correcta del tag
        run: |
          cd $PLUGIN_NAME
          # Usamos jq para actualizar la versi√≥n en el manifest.json al vuelo
          # Si no tienes un manifest en public, aseg√∫rate de crearlo o generarlo aqu√≠
          
          # Opci√≥n A: Si ya tienes public/manifest.json, lo copiamos a dist (Vite lo hace solo)
          # Pero vamos a forzar que la versi√≥n del JSON coincida con el tag
          tmp=$(mktemp)
          jq --arg v "$VERSION" '.meta.version = $v' dist/manifest.json > "$tmp" && mv "$tmp" dist/manifest.json
          
          echo "‚úÖ Manifest actualizado a v$VERSION"

      - name: ü§ê Zip Package (.hubbi)
        run: |
          cd $PLUGIN_NAME/dist
          # Comprimimos el contenido de dist
          zip -r ../../$PLUGIN_NAME.hubbi .
          
          echo "üì¶ Paquete generado: $PLUGIN_NAME.hubbi"

      - name: üöÄ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.PLUGIN_NAME }}.hubbi
          name: "${{ env.PLUGIN_NAME }} v${{ env.VERSION }}"
          body: |
            üöÄ **Nuevo Release del M√≥dulo**
            - Plugin: `${{ env.PLUGIN_NAME }}`
            - Versi√≥n: `${{ env.VERSION }}`
            
            Descarga el archivo `.hubbi` e imp√≥rtalo en tu aplicaci√≥n.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}