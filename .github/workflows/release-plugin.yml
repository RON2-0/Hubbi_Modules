name: Release Plugin ğŸ“¦

on:
  push:
    tags:
      - '*@*' # Se activa SOLO cuando subes un tag con formato "nombre@version"

permissions:
  contents: write # Permiso para crear Releases y subir archivos

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      # 1. Bajar el cÃ³digo
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      # 2. Detectar quÃ© plugin estamos liberando basado en el Tag
      - name: ğŸ·ï¸ Parse Tag
        id: tag_info
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Tag original: $TAG_NAME"
          
          # Separamos el nombre y la versiÃ³n (ej: hubbi-plugin-billing@1.0.0)
          # Todo antes del Ãºltimo @ es el nombre
          PLUGIN_NAME=${TAG_NAME%@*}
          # Todo despuÃ©s del Ãºltimo @ es la versiÃ³n
          VERSION=${TAG_NAME##*@}
          
          # Guardamos en outputs para usarlo en los siguientes pasos
          echo "plugin_name=$PLUGIN_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "ğŸ¯ Objetivo detectado: $PLUGIN_NAME (v$VERSION)"

      # 3. Verificar que la carpeta existe (Seguridad)
      - name: ğŸ” Verify Plugin Exists
        run: |
          if [ ! -d "${{ steps.tag_info.outputs.plugin_name }}" ]; then
            echo "âŒ Error: No existe la carpeta '${{ steps.tag_info.outputs.plugin_name }}' en el repositorio."
            echo "AsegÃºrate de que el tag coincida con el nombre de la carpeta."
            exit 1
          fi

      # 4. Preparar entorno Node.js
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 5. Instalar dependencias SOLO de ese plugin
      - name: ğŸ“¦ Install Dependencies
        run: |
          cd ${{ steps.tag_info.outputs.plugin_name }}
          npm install

      # 6. Compilar el Plugin (Genera dist/index.umd.cjs)
      - name: ğŸ› ï¸ Build Plugin
        run: |
          cd ${{ steps.tag_info.outputs.plugin_name }}
          npm run build

      # 7. Asegurar que el manifest tenga la versiÃ³n correcta
      # (Truco Pro: Sobrescribimos la versiÃ³n del json con la del tag para que siempre coincidan)
      - name: ğŸ“„ Sync Manifest Version
        run: |
          cd ${{ steps.tag_info.outputs.plugin_name }}
          # Usamos jq (herramienta de linux) para editar el json al vuelo
          # Si el manifest estÃ¡ en dist/ (copiado por vite)
          if [ -f "dist/manifest.json" ]; then
             tmp=$(mktemp)
             jq --arg v "${{ steps.tag_info.outputs.version }}" '.meta.version = $v' dist/manifest.json > "$tmp" && mv "$tmp" dist/manifest.json
             echo "âœ… Manifest actualizado a versiÃ³n ${{ steps.tag_info.outputs.version }}"
          else
             echo "âš ï¸ No se encontrÃ³ manifest.json en dist/"
          fi

      # 8. Empaquetar (.hubbi es solo un .zip renombrado)
      - name: ğŸ¤ Zip Package
        run: |
          cd ${{ steps.tag_info.outputs.plugin_name }}/dist
          # Comprimimos todo el contenido de dist en un archivo con el nombre del plugin
          zip -r ../../${{ steps.tag_info.outputs.plugin_name }}.hubbi .
          echo "ğŸ“¦ Paquete generado: ${{ steps.tag_info.outputs.plugin_name }}.hubbi"

      # 9. Publicar Release en GitHub
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.tag_info.outputs.plugin_name }}.hubbi
          name: "${{ steps.tag_info.outputs.plugin_name }} v${{ steps.tag_info.outputs.version }}"
          body: |
            ğŸš€ **Nuevo MÃ³dulo Disponible**
            
            - **Plugin:** `${{ steps.tag_info.outputs.plugin_name }}`
            - **VersiÃ³n:** `${{ steps.tag_info.outputs.version }}`
            
            *InstalaciÃ³n:* Descarga el archivo `.hubbi` adjunto e impÃ³rtalo en Hubbi Store.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}